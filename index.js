"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const bluebird_1 = __importDefault(require("bluebird"));
const path_1 = __importDefault(require("path"));
const common_1 = require("./common");
const packer_1 = require("./packer");
const reducers_1 = require("./reducers");
const vortex_api_1 = require("vortex-api");
const util_1 = require("./util");
const migrations_1 = require("./migrations");
const NATIVES_DIR = 'natives' + path_1.default.sep;
const LUA_EXT = '.lua';
const PAK_EXT = '.pak';
const STEAM_ID = '1446780';
function findGame() {
    return vortex_api_1.util.steam.findByAppId(STEAM_ID)
        .then(game => game.gamePath);
}
function queryREFramework(api) {
    const state = api.getState();
    const dinput = Object.values(state.persistent.mods[common_1.GAME_ID])
        .find(mod => mod.type === 'dinput');
    if (dinput !== undefined) {
        return Promise.resolve();
    }
    return new Promise((resolve) => api.showDialog('info', 'Soft requirement: REFramework', {
        text: 'Many mods for Monster Hunter Rise (mods that include lua scripts) '
            + 'require the mod REFramework to be installed in order to function correctly. '
            + 'You can download it from the Nexus Mods website by clicking the Vortex button '
            + 'in the top right corner. Once installed, please ensure it is enabled and deployed at all times.',
    }, [
        { label: 'Continue' },
        {
            label: 'Go to Mod Page',
            action: () => vortex_api_1.util.opn('https://www.nexusmods.com/monsterhunterrise/mods/26')
                .catch(err => null)
        },
    ]).then(() => resolve()));
}
function prepareForModding(api, discovery, packer) {
    return packer.ensurePacker()
        .then(() => vortex_api_1.fs.ensureDirWritableAsync(path_1.default.join(discovery.path, 'natives')))
        .then(() => vortex_api_1.fs.ensureDirWritableAsync(path_1.default.join(discovery.path, 'reframework', 'autorun')))
        .then(() => queryREFramework(api));
}
function testSupportedPAK(files, gameId) {
    const supported = (gameId === common_1.GAME_ID)
        && (files.find(file => path_1.default.extname(file) === PAK_EXT) !== undefined);
    return Promise.resolve({
        supported,
        requiredFiles: [],
    });
}
function installPAK(api, files, packer) {
    const paks = files.filter(file => path_1.default.extname(file) === PAK_EXT);
    return bluebird_1.default.map(paks, file => packer.getNextPatch(api)
        .then((patch) => {
        const destination = path_1.default.basename(file).match(/re_chunk_000.pak.patch_[0-9]*.pak/gm) !== null
            ? path_1.default.basename(file)
            : `re_chunk_000.pak.patch_${patch}.pak`;
        return bluebird_1.default.resolve(({
            type: 'copy',
            source: file,
            destination,
        }));
    }))
        .then(instructions => Promise.resolve({ instructions }));
}
function testSupportedLUA(files, gameId) {
    const supported = (gameId === common_1.GAME_ID)
        && (files.find(file => path_1.default.extname(file) === LUA_EXT) !== undefined);
    return Promise.resolve({
        supported,
        requiredFiles: [],
    });
}
function installLUA(files) {
    const modTypeInstruction = {
        type: 'setmodtype',
        value: 'mhr-lua-mod',
    };
    const luaInstructions = files.filter(file => path_1.default.extname(file) === LUA_EXT)
        .map(file => {
        const segments = file.split(path_1.default.sep);
        const idx = segments.findIndex(seg => seg.toLowerCase() === 'autorun');
        const destination = (idx !== -1)
            ? segments.slice(idx).join(path_1.default.sep)
            : path_1.default.join('autorun', path_1.default.basename(file));
        return {
            type: 'copy',
            source: file,
            destination,
        };
    });
    const otherFiles = files.filter(file => path_1.default.extname(file) !== LUA_EXT
        && path_1.default.extname(file) !== '')
        .map(file => ({
        type: 'copy',
        source: file,
        destination: file,
    }));
    const instructions = [].concat(modTypeInstruction, luaInstructions, otherFiles);
    return Promise.resolve({ instructions });
}
function testSupportedLoose(files, gameId) {
    const supported = (gameId === common_1.GAME_ID)
        && (files.find(file => file.indexOf(NATIVES_DIR) !== -1) !== undefined);
    return Promise.resolve({
        supported,
        requiredFiles: [],
    });
}
function installLoose(files, destinationPath, gameId, progressDelegate) {
    return __awaiter(this, void 0, void 0, function* () {
        const rootPath = files.find(file => file.endsWith(NATIVES_DIR));
        const idx = rootPath.length - NATIVES_DIR.length;
        let filtered = files.filter(file => ((file.indexOf(rootPath) !== -1)
            && (!file.endsWith(path_1.default.sep))));
        filtered = filtered.map(file => {
            return {
                source: file,
                destination: file.substr(idx),
            };
        });
        const modTypeInstruction = {
            type: 'setmodtype',
            value: 'mhr-loose-files',
        };
        const instructions = [modTypeInstruction].concat(filtered.map(file => {
            return {
                type: 'copy',
                source: file.source,
                destination: file.destination.toLowerCase(),
            };
        }));
        return Promise.resolve({ instructions });
    });
}
function main(context) {
    context.registerReducer(['settings', common_1.GAME_ID], reducers_1.reducer);
    const isMHR = (gameId = undefined) => {
        if (gameId !== undefined) {
            return (gameId === common_1.GAME_ID);
        }
        const state = context.api.getState();
        const gameMode = vortex_api_1.selectors.activeGameId(state);
        return (gameMode === common_1.GAME_ID);
    };
    const packer = new packer_1.PackerMod(context.api);
    context.registerGame({
        id: common_1.GAME_ID,
        name: 'Monster Hunter Rise',
        compatible: { usvfs: false },
        logo: 'gameart.jpg',
        mergeMods: true,
        queryPath: findGame,
        queryModPath: () => '.',
        executable: () => 'MonsterHunterRise.exe',
        requiredFiles: ['MonsterHunterRise.exe', common_1.GAME_PAK_FILE],
        environment: {
            SteamAPPId: STEAM_ID.toString(),
        },
        setup: (discovery) => prepareForModding(context.api, discovery, packer),
    });
    context.registerMigration(old => (0, migrations_1.migrate102)(context, old));
    context.registerInstaller('mhr-pak-mod', 25, testSupportedPAK, (files) => installPAK(context.api, files, packer));
    context.registerInstaller('mhr-loose-files-installer', 25, testSupportedLoose, installLoose);
    context.registerInstaller('mhr-lua-installer', 25, testSupportedLUA, installLUA);
    context.registerModType('mhr-loose-files', 25, isMHR, () => undefined, () => bluebird_1.default.resolve(false), { name: 'Loose Files' });
    context.registerModType('mhr-packer', 25, isMHR, () => undefined, () => bluebird_1.default.resolve(false), { name: 'Packer (Do not use)' });
    context.registerModType('mhr-lua-mod', 25, isMHR, () => {
        const state = context.api.getState();
        const discovery = vortex_api_1.selectors.discoveryByGame(state, common_1.GAME_ID);
        return path_1.default.join(discovery.path, 'reframework');
    }, () => bluebird_1.default.resolve(false), { name: 'Lua Mod' });
    context.once(() => {
        context.api.onAsync('will-deploy', (profileId, deployment) => __awaiter(this, void 0, void 0, function* () {
            var _a;
            const state = context.api.getState();
            const profile = state.persistent.profiles[profileId];
            if ((profile === null || profile === void 0 ? void 0 : profile.gameId) !== common_1.GAME_ID) {
                return;
            }
            const mods = state.persistent.mods[common_1.GAME_ID];
            if (mods === undefined) {
                return;
            }
            const looseMods = Object.values(mods).filter(mod => mod.type === 'mhr-loose-files');
            if (looseMods.length === 0) {
                return;
            }
            const packerMod = (_a = Object.values(mods).filter(mod => mod.type === 'mhr-packer')) === null || _a === void 0 ? void 0 : _a[0];
            if (packerMod === undefined) {
                return;
            }
            const stagingFolder = vortex_api_1.selectors.installPathForGame(state, common_1.GAME_ID);
            const modFiles = yield looseMods.reduce((accumP, iter) => __awaiter(this, void 0, void 0, function* () {
                let accum = yield accumP;
                const modPath = path_1.default.join(stagingFolder, iter.installationPath);
                const files = yield (0, util_1.walkDirPath)(modPath);
                accum = accum.concat(files.filter(file => path_1.default.extname(file.filePath) !== '')
                    .map(file => file.filePath));
                return accum;
            }), Promise.resolve([]));
            const copiedFiles = [];
            for (let file of modFiles) {
                const relPath = path_1.default.relative(stagingFolder, file)
                    .split(path_1.default.sep)
                    .slice(1)
                    .join(path_1.default.sep);
                const dest = path_1.default.join(stagingFolder, packerMod.installationPath, relPath);
                yield vortex_api_1.fs.ensureDirWritableAsync(path_1.default.dirname(dest));
                yield vortex_api_1.fs.linkAsync(file, dest).catch(err => null);
                copiedFiles.push(dest);
            }
            try {
                const pakFile = yield packer.runPacker();
                copiedFiles.push(pakFile);
                const mergedModName = 'mergedPak';
                const dest = path_1.default.join(stagingFolder, mergedModName, path_1.default.basename(pakFile));
                yield vortex_api_1.fs.removeAsync(dest).catch(err => null);
                yield packer.createMergedMod(mergedModName);
                yield vortex_api_1.fs.linkAsync(pakFile, dest).catch(err => null);
            }
            catch (err) {
                context.api.showErrorNotification('Failed to merge loose files', err);
            }
            for (let file of copiedFiles) {
                yield vortex_api_1.fs.removeAsync(file);
            }
        }));
    });
}
exports.default = main;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUFBLHdEQUFnQztBQUNoQyxnREFBd0I7QUFFeEIscUNBQWtEO0FBQ2xELHFDQUFxQztBQUNyQyx5Q0FBcUM7QUFHckMsMkNBQXdEO0FBQ3hELGlDQUFxQztBQUVyQyw2Q0FBMEM7QUFFMUMsTUFBTSxXQUFXLEdBQUcsU0FBUyxHQUFHLGNBQUksQ0FBQyxHQUFHLENBQUM7QUFFekMsTUFBTSxPQUFPLEdBQUcsTUFBTSxDQUFDO0FBQ3ZCLE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQztBQUV2QixNQUFNLFFBQVEsR0FBRyxTQUFTLENBQUM7QUFFM0IsU0FBUyxRQUFRO0lBQ2YsT0FBTyxpQkFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDO1NBQ3BDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNqQyxDQUFDO0FBRUQsU0FBUyxnQkFBZ0IsQ0FBQyxHQUF3QjtJQUNoRCxNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDN0IsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxnQkFBTyxDQUFDLENBQUM7U0FDekQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksS0FBSyxRQUFRLENBQUMsQ0FBQztJQUV0QyxJQUFJLE1BQU0sS0FBSyxTQUFTLEVBQUU7UUFDeEIsT0FBTyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7S0FDMUI7SUFFRCxPQUFPLElBQUksT0FBTyxDQUFPLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FDbkMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsK0JBQStCLEVBQUU7UUFDdEQsSUFB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QUFDLENBQUMsQ0FBQztBQUNMLENBQUM7QUF2R0QsdUJBdUdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEJsdWViaXJkIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuXG5pbXBvcnQgeyBHQU1FX0lELCBHQU1FX1BBS19GSUxFIH0gZnJvbSAnLi9jb21tb24nO1xuaW1wb3J0IHsgUGFja2VyTW9kIH0gZnJvbSAnLi9wYWNrZXInO1xuaW1wb3J0IHsgcmVkdWNlciB9IGZyb20gJy4vcmVkdWNlcnMnO1xuaW1wb3J0IHsgSURlcGxveW1lbnQgfSBmcm9tICcuL3R5cGVzJztcblxuaW1wb3J0IHsgZnMsIHNlbGVjdG9ycywgdHlwZXMsIHV0aWwgfSBmcm9tICd2b3J0ZXgtYXBpJztcbmltcG9ydCB7IHdhbGtEaXJQYXRoIH0gZnJvbSAnLi91dGlsJztcblxuaW1wb3J0IHsgbWlncmF0ZTEwMiB9IGZyb20gJy4vbWlncmF0aW9ucyc7XG5cbmNvbnN0IE5BVElWRVNfRElSID0gJ25hdGl2ZXMnICsgcGF0aC5zZXA7XG5cbmNvbnN0IExVQV9FWFQgPSAnLmx1YSc7XG5jb25zdCBQQUtfRVhUID0gJy5wYWsnO1xuXG5jb25zdCBTVEVBTV9JRCA9ICcxNDQ2NzgwJztcblxuZnVuY3Rpb24gZmluZEdhbWUoKSB7XG4gIHJldHVybiB1dGlsLnN0ZWFtLmZpbmRCeUFwcElkKFNURUFNX0lEKVxuICAgIC50aGVuKGdhbWUgPT4gZ2FtZS5nYW1lUGF0aCk7XG59XG5cbmZ1bmN0aW9uIHF1ZXJ5UkVGcmFtZXdvcmsoYXBpOiB0eXBlcy5JRXh0ZW5zaW9uQXBpKSB7XG4gIGNvbnN0IHN0YXRlID0gYXBpLmdldFN0YXRlKCk7XG4gIGNvbnN0IGRpbnB1dCA9IE9iamVjdC52YWx1ZXMoc3RhdGUucGVyc2lzdGVudC5tb2RzW0dBTUVfSURdKVxuICAgIC5maW5kKG1vZCA9PiBtb2QudHlwZSA9PT0gJ2RpbnB1dCcpO1xuXG4gIGlmIChkaW5wdXQgIT09IHVuZGVmaW5lZCkge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgfVxuXG4gIHJldHVybiBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSkgPT5cbiAgICBhcGkuc2hvd0RpYWxvZygnaW5mbycsICdTb2Z0IHJlcXVpcmVtZW50OiBSRUZyYW1ld29yaycsIHtcbiAgICAgIHRleHQ6ICdNYW55IG1vZHMgZm9yIE1vbnN0ZXIgSHVudGVyIFJpc2UgKG1vZHMgdGhhdCBpbmNsdWRlIGx1YSBzY3JpcHRzKSAnXG4gICAgICAgICAgKyAncmVxdWlyZSB0aGUgbW9kIFJFRnJhbWV3b3JrIHRvIGJlIGluc3RhbGxlZCBpbiBvcmRlciB0byBmdW5jdGlvbiBjb3JyZWN0bHkuICdcbiAgICAgICAgICArICdZb3UgY2FuIGRvd25sb2FkIGl0IGZyb20gdGhlIE5leHVzIE1vZHMgd2Vic2l0ZSBieSBjbGlja2luZyB0aGUgVm9ydGV4IGJ1dHRvbiAnXG4gICAgICAgICAgKyAnaW4gdGhlIHRvcCByaWdodCBjb3JuZXIuIE9uY2UgaW5zdGFsbGVkLCBwbGVhc2UgZW5zdXJlIGl0IGlzIGVuYWJsZWQgYW5kIGRlcGxveWVkIGF0IGFsbCB0aW1lcy4nLFxuICAgIH0sIFtcbiAgICAgIHsgbGFiZWw6ICdDb250aW51ZScgfSxcbiAgICAgIHtcbiAgICAgICAgbGFiZWw6ICdHbyB0byBNb2QgUGFnZScsXG4gICAgICAgIGFjdGlvbjogKCkgPT4gdXRpbC5vcG4oJ2h0dHBzOi8vd3d3Lm5leHVzbW9kcy5jb20vbW9uc3Rlcmh1bnRlcnJpc2UvbW9kcy8yNicpXG4gICAgICAgICAgLmNhdGNoKGVyciA9PiBudWxsKSB9LFxuICAgIF0pLnRoZW4oKCkgPT4gcmVzb2x2ZSgpKSk7XG59XG5cbmZ1bmN0aW9uIHByZXBhcmVGb3JNb2RkaW5nKGFwaTogdHlwZXMuSUV4dGVuc2lvbkFwaSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2NvdmVyeTogdHlwZXMuSURpc2NvdmVyeVJlc3VsdCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhY2tlcjogUGFja2VyTW9kKSB7XG4gIHJldHVybiBwYWNrZXIuZW5zdXJlUGFja2VyKClcbiAgICAudGhlbigoKSA9PiBmcy5lbnN1cmVEaXJXcml0YWJsZUFzeW5jKHBhdGguam9pbihkaXNjb3ZlcnkucGF0aCwgJ25hdGl2ZXMnKSkpXG4gICAgLnRoZW4oKCkgPT4gZnMuZW5zdXJlRGlyV3JpdGFibGVBc3luYyhwYXRoLmpvaW4oZGlzY292ZXJ5LnBhdGgsICdyZWZyYW1ld29yaycsICdhdXRvcnVuJykpKVxuICAgIC50aGVuKCgpID0+IHF1ZXJ5UkVGcmFtZXdvcmsoYXBpKSk7XG59XG5cbmZ1bmN0aW9uIHRlc3RTdXBwb3J0ZWRQQUsoZmlsZXMsIGdhbWVJZCkge1xuICBjb25zdCBzdXBwb3J0ZWQgPSAoZ2FtZUlkID09PSBHQU1FX0lEKVxuICAgICYmIChmaWxlcy5maW5kKGZpbGUgPT4gcGF0aC5leHRuYW1lKGZpbGUpID09PSBQQUtfRVhUKSAhPT0gdW5kZWZpbmVkKTtcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgc3VwcG9ydGVkLFxuICAgIHJlcXVpcmVkRmlsZXM6IFtdLFxuICB9KTtcbn1cblxuZnVuY3Rpb24gaW5zdGFsbFBBSyhhcGk6IHR5cGVzLklFeHRlbnNpb25BcGksIGZpbGVzOiBzdHJpbmdbXSwgcGFja2VyOiBQYWNrZXJNb2QpIHtcbiAgY29uc3QgcGFrcyA9IGZpbGVzLmZpbHRlcihmaWxlID0+IHBhdGguZXh0bmFtZShmaWxlKSA9PT0gUEFLX0VYVCk7XG4gIHJldHVybiBCbHVlYmlyZC5tYXAocGFrcywgZmlsZSA9PiBwYWNrZXIuZ2V0TmV4dFBhdGNoKGFwaSlcbiAgICAudGhlbigocGF0Y2gpID0+IHtcbiAgICAgIGNvbnN0IGRlc3RpbmF0aW9uID0gcGF0aC5iYXNlbmFtZShmaWxlKS5tYXRjaCgvcmVfY2h1bmtfMDAwLnBhay5wYXRjaF9bMC05XSoucGFrL2dtKSAhPT0gbnVsbFxuICAgICAgICA/IHBhdGguYmFzZW5hbWUoZmlsZSlcbiAgICAgICAgOiBgcmVfY2h1bmtfMDAwLnBhay5wYXRjaF8ke3BhdGNofS5wYWtgO1xuICAgICAgcmV0dXJuIEJsdWViaXJkLnJlc29sdmUoKHtcbiAgICAgICAgdHlwZTogJ2NvcHknLFxuICAgICAgICBzb3VyY2U6IGZpbGUsXG4gICAgICAgIGRlc3RpbmF0aW9uLFxuICAgICAgfSkpO1xuICAgIH0pKVxuICAudGhlbihpbnN0cnVjdGlvbnMgPT4gUHJvbWlzZS5yZXNvbHZlKHsgaW5zdHJ1Y3Rpb25zIH0pKTtcbn1cblxuZnVuY3Rpb24gdGVzdFN1cHBvcnRlZExVQShmaWxlcywgZ2FtZUlkKSB7XG4gIGNvbnN0IHN1cHBvcnRlZCA9IChnYW1lSWQgPT09IEdBTUVfSUQpXG4gICAgJiYgKGZpbGVzLmZpbmQoZmlsZSA9PiBwYXRoLmV4dG5hbWUoZmlsZSkgPT09IExVQV9FWFQpICE9PSB1bmRlZmluZWQpO1xuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHtcbiAgICBzdXBwb3J0ZWQsXG4gICAgcmVxdWlyZWRGaWxlczogW10sXG4gIH0pO1xufVxuXG5mdW5jdGlvbiBpbnN0YWxsTFVBKGZpbGVzKSB7XG4gIGNvbnN0IG1vZFR5cGVJbnN0cnVjdGlvbiA9IHtcbiAgICB0eXBlOiAnc2V0bW9kdHlwZScsXG4gICAgdmFsdWU6ICdtaHItbHVhLW1vZCcsXG4gIH07XG4gIGNvbnN0IGx1YUluc3RydWN0aW9ucyA9IGZpbGVzLmZpbHRlcihmaWxlID0+IHBhdGguZXh0bmFtZShmaWxlKSA9PT0gTFVBX0VYVClcbiAgICAubWFwKGZpbGUgPT4ge1xuICAgICAgY29uc3Qgc2VnbWVudHMgPSBmaWxlLnNwbGl0KHBhdGguc2VwKTtcbiAgICAgIGNvbnN0IGlkeCA9IHNlZ21lbnRzLmZpbmRJbmRleChzZWcgPT4gc2VnLnRvTG93ZXJDYXNlKCkgPT09ICdhdXRvcnVuJyk7XG4gICAgICBjb25zdCBkZXN0aW5hdGlvbiA9IChpZHggIT09IC0xKVxuICAgICAgICA/IHNlZ21lbnRzLnNsaWNlKGlkeCkuam9pbihwYXRoLnNlcClcbiAgICAgICAgOiBwYXRoLmpvaW4oJ2F1dG9ydW4nLCBwYXRoLmJhc2VuYW1lKGZpbGUpKTtcbiAgICAgIHJldHVybiB7XG4gICAgICB0eXBlOiAnY29weScsXG4gICAgICBzb3VyY2U6IGZpbGUsXG4gICAgICBkZXN0aW5hdGlvbixcbiAgICB9O1xuICB9KTtcbiAgY29uc3Qgb3RoZXJGaWxlcyA9IGZpbGVzLmZpbHRlcihmaWxlID0+IHBhdGguZXh0bmFtZShmaWxlKSAhPT0gTFVBX0VYVFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgcGF0aC5leHRuYW1lKGZpbGUpICE9PSAnJylcbiAgICAubWFwKGZpbGUgPT4gKHtcbiAgICAgIHR5cGU6ICdjb3B5JyxcbiAgICAgIHNvdXJjZTogZmlsZSxcbiAgICAgIGRlc3RpbmF0aW9uOiBmaWxlLFxuICAgIH0pKTtcbiAgY29uc3QgaW5zdHJ1Y3Rpb25zID0gW10uY29uY2F0KG1vZFR5cGVJbnN0cnVjdGlvbiwgbHVhSW5zdHJ1Y3Rpb25zLCBvdGhlckZpbGVzKTtcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IGluc3RydWN0aW9ucyB9KTtcbn1cblxuZnVuY3Rpb24gdGVzdFN1cHBvcnRlZExvb3NlKGZpbGVzLCBnYW1lSWQpIHtcbiAgLy8gTWFrZSBzdXJlIHdlJ3JlIGFibGUgdG8gc3VwcG9ydCB0aGlzIG1vZC5cbiAgY29uc3Qgc3VwcG9ydGVkID0gKGdhbWVJZCA9PT0gR0FNRV9JRClcbiAgICAmJiAoZmlsZXMuZmluZChmaWxlID0+IGZpbGUuaW5kZXhPZihOQVRJVkVTX0RJUikgIT09IC0xKSAhPT0gdW5kZWZpbmVkKTtcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgc3VwcG9ydGVkLFxuICAgIHJlcXVpcmVkRmlsZXM6IFtdLFxuICB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gaW5zdGFsbExvb3NlKGZpbGVzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uUGF0aCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYW1lSWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3NEZWxlZ2F0ZSkge1xuICBjb25zdCByb290UGF0aCA9IGZpbGVzLmZpbmQoZmlsZSA9PiBmaWxlLmVuZHNXaXRoKE5BVElWRVNfRElSKSk7XG4gIGNvbnN0IGlkeCA9IHJvb3RQYXRoLmxlbmd0aCAtIE5BVElWRVNfRElSLmxlbmd0aDtcbiAgLy8gUmVtb3ZlIGRpcmVjdG9yaWVzIGFuZCBhbnl0aGluZyB0aGF0IGlzbid0IGluIHRoZSByb290UGF0aC5cbiAgbGV0IGZpbHRlcmVkID0gZmlsZXMuZmlsdGVyKGZpbGUgPT5cbiAgICAoKGZpbGUuaW5kZXhPZihyb290UGF0aCkgIT09IC0xKVxuICAgICAgJiYgKCFmaWxlLmVuZHNXaXRoKHBhdGguc2VwKSkpKTtcblxuICBmaWx0ZXJlZCA9IGZpbHRlcmVkLm1hcChmaWxlID0+IHtcbiAgICByZXR1cm4ge1xuICAgICAgc291cmNlOiBmaWxlLFxuICAgICAgZGVzdGluYXRpb246IGZpbGUuc3Vic3RyKGlkeCksXG4gICAgfTtcbiAgfSk7XG5cbiAgY29uc3QgbW9kVHlwZUluc3RydWN0aW9uID0ge1xuICAgIHR5cGU6ICdzZXRtb2R0eXBlJyxcbiAgICB2YWx1ZTogJ21oci1sb29zZS1maWxlcycsXG4gIH07XG4gIGNvbnN0IGluc3RydWN0aW9ucyA9IFttb2RUeXBlSW5zdHJ1Y3Rpb25dLmNvbmNhdChmaWx0ZXJlZC5tYXAoZmlsZSA9PiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGU6ICdjb3B5JyxcbiAgICAgIHNvdXJjZTogZmlsZS5zb3VyY2UsXG4gICAgICBkZXN0aW5hdGlvbjogZmlsZS5kZXN0aW5hdGlvbi50b0xvd2VyQ2FzZSgpLFxuICAgIH07XG4gIH0pKTtcblxuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgaW5zdHJ1Y3Rpb25zIH0pO1xufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBtYWluKGNvbnRleHQpIHtcbiAgY29udGV4dC5yZWdpc3RlclJlZHVjZXIoWydzZXR0aW5ncycsIEdBTUVfSURdLCByZWR1Y2VyKTtcbiAgY29uc3QgaXNNSFIgPSAoZ2FtZUlkID0gdW5kZWZpbmVkKSA9PiB7XG4gICAgaWYgKGdhbWVJZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gKGdhbWVJZCA9PT0gR0FNRV9JRCk7XG4gICAgfVxuICAgIGNvbnN0IHN0YXRlID0gY29udGV4dC5hcGkuZ2V0U3RhdGUoKTtcbiAgICBjb25zdCBnYW1lTW9kZSA9IHNlbGVjdG9ycy5hY3RpdmVHYW1lSWQoc3RhdGUpO1xuICAgIHJldHVybiAoZ2FtZU1vZGUgPT09IEdBTUVfSUQpO1xuICB9O1xuICBjb25zdCBwYWNrZXIgPSBuZXcgUGFja2VyTW9kKGNvbnRleHQuYXBpKTtcbiAgY29udGV4dC5yZWdpc3RlckdhbWUoe1xuICAgIGlkOiBHQU1FX0lELFxuICAgIG5hbWU6ICdNb25zdGVyIEh1bnRlciBSaXNlJyxcbiAgICBjb21wYXRpYmxlOiB7IHVzdmZzOiBmYWxzZSB9LFxuICAgIGxvZ286ICdnYW1lYXJ0LmpwZycsXG4gICAgbWVyZ2VNb2RzOiB0cnVlLFxuICAgIHF1ZXJ5UGF0aDogZmluZEdhbWUsXG4gICAgcXVlcnlNb2RQYXRoOiAoKSA9PiAnLicsXG4gICAgZXhlY3V0YWJsZTogKCkgPT4gJ01vbnN0ZXJIdW50ZXJSaXNlLmV4ZScsXG4gICAgcmVxdWlyZWRGaWxlczogWydNb25zdGVySHVudGVyUmlzZS5leGUnLCBHQU1FX1BBS19GSUxFXSxcbiAgICBlbnZpcm9ubWVudDoge1xuICAgICAgU3RlYW1BUFBJZDogU1RFQU1fSUQudG9TdHJpbmcoKSxcbiAgICB9LFxuICAgIHNldHVwOiAoZGlzY292ZXJ5KSA9PiBwcmVwYXJlRm9yTW9kZGluZyhjb250ZXh0LmFwaSwgZGlzY292ZXJ5LCBwYWNrZXIpLFxuICB9KTtcblxuICBjb250ZXh0LnJlZ2lzdGVyTWlncmF0aW9uKG9sZCA9PiBtaWdyYXRlMTAyKGNvbnRleHQsIG9sZCkpO1xuXG4gIGNvbnRleHQucmVnaXN0ZXJJbnN0YWxsZXIoJ21oci1wYWstbW9kJywgMjUsIHRlc3RTdXBwb3J0ZWRQQUssXG4gICAgKGZpbGVzKSA9PiBpbnN0YWxsUEFLKGNvbnRleHQuYXBpLCBmaWxlcywgcGFja2VyKSk7XG4gIGNvbnRleHQucmVnaXN0ZXJJbnN0YWxsZXIoJ21oci1sb29zZS1maWxlcy1pbnN0YWxsZXInLCAyNSwgdGVzdFN1cHBvcnRlZExvb3NlLCBpbnN0YWxsTG9vc2UpO1xuICBjb250ZXh0LnJlZ2lzdGVySW5zdGFsbGVyKCdtaHItbHVhLWluc3RhbGxlcicsIDI1LCB0ZXN0U3VwcG9ydGVkTFVBLCBpbnN0YWxsTFVBKTtcblxuICBjb250ZXh0LnJlZ2lzdGVyTW9kVHlwZSgnbWhyLWxvb3NlLWZpbGVzJywgMjUsIGlzTUhSLFxuICAgICgpID0+IHVuZGVmaW5lZCwgKCkgPT4gQmx1ZWJpcmQucmVzb2x2ZShmYWxzZSksIHsgbmFtZTogJ0xvb3NlIEZpbGVzJyB9KTtcbiAgY29udGV4dC5yZWdpc3Rlck1vZFR5cGUoJ21oci1wYWNrZXInLCAyNSwgaXNNSFIsXG4gICAgKCkgPT4gdW5kZWZpbmVkLCAoKSA9PiBCbHVlYmlyZC5yZXNvbHZlKGZhbHNlKSwgeyBuYW1lOiAnUGFja2VyIChEbyBub3QgdXNlKScgfSk7XG4gIGNvbnRleHQucmVnaXN0ZXJNb2RUeXBlKCdtaHItbHVhLW1vZCcsIDI1LCBpc01IUixcbiAgICAoKSA9PiB7XG4gICAgICBjb25zdCBzdGF0ZSA9IGNvbnRleHQuYXBpLmdldFN0YXRlKCk7XG4gICAgICBjb25zdCBkaXNjb3ZlcnkgPSBzZWxlY3RvcnMuZGlzY292ZXJ5QnlHYW1lKHN0YXRlLCBHQU1FX0lEKTtcbiAgICAgIHJldHVybiBwYXRoLmpvaW4oZGlzY292ZXJ5LnBhdGgsICdyZWZyYW1ld29yaycpO1xuICAgIH0sICgpID0+IEJsdWViaXJkLnJlc29sdmUoZmFsc2UpLCB7IG5hbWU6ICdMdWEgTW9kJyB9KTtcbiAgY29udGV4dC5vbmNlKCgpID0+IHtcbiAgICBjb250ZXh0LmFwaS5vbkFzeW5jKCd3aWxsLWRlcGxveScsXG4gICAgICBhc3luYyAocHJvZmlsZUlkOiBzdHJpbmcsIGRlcGxveW1lbnQ6IElEZXBsb3ltZW50KSA9PiB7XG4gICAgICAgIGNvbnN0IHN0YXRlOiB0eXBlcy5JU3RhdGUgPSBjb250ZXh0LmFwaS5nZXRTdGF0ZSgpO1xuICAgICAgICBjb25zdCBwcm9maWxlID0gc3RhdGUucGVyc2lzdGVudC5wcm9maWxlc1twcm9maWxlSWRdO1xuICAgICAgICBpZiAocHJvZmlsZT8uZ2FtZUlkICE9PSBHQU1FX0lEKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IG1vZHMgPSBzdGF0ZS5wZXJzaXN0ZW50Lm1vZHNbR0FNRV9JRF07XG4gICAgICAgIGlmIChtb2RzID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgbG9vc2VNb2RzID0gT2JqZWN0LnZhbHVlcyhtb2RzKS5maWx0ZXIobW9kID0+IG1vZC50eXBlID09PSAnbWhyLWxvb3NlLWZpbGVzJyk7XG4gICAgICAgIGlmIChsb29zZU1vZHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHBhY2tlck1vZCA9IE9iamVjdC52YWx1ZXMobW9kcykuZmlsdGVyKG1vZCA9PiBtb2QudHlwZSA9PT0gJ21oci1wYWNrZXInKT8uWzBdO1xuICAgICAgICBpZiAocGFja2VyTW9kID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgc3RhZ2luZ0ZvbGRlciA9IHNlbGVjdG9ycy5pbnN0YWxsUGF0aEZvckdhbWUoc3RhdGUsIEdBTUVfSUQpO1xuICAgICAgICBjb25zdCBtb2RGaWxlcyA9IGF3YWl0IGxvb3NlTW9kcy5yZWR1Y2UoYXN5bmMgKGFjY3VtUCwgaXRlcikgPT4ge1xuICAgICAgICAgIGxldCBhY2N1bSA9IGF3YWl0IGFjY3VtUDtcbiAgICAgICAgICBjb25zdCBtb2RQYXRoID0gcGF0aC5qb2luKHN0YWdpbmdGb2xkZXIsIGl0ZXIuaW5zdGFsbGF0aW9uUGF0aCk7XG4gICAgICAgICAgY29uc3QgZmlsZXMgPSBhd2FpdCB3YWxrRGlyUGF0aChtb2RQYXRoKTtcbiAgICAgICAgICBhY2N1bSA9IGFjY3VtLmNvbmNhdChmaWxlcy5maWx0ZXIoZmlsZSA9PiBwYXRoLmV4dG5hbWUoZmlsZS5maWxlUGF0aCkgIT09ICcnKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLm1hcChmaWxlID0+IGZpbGUuZmlsZVBhdGgpKTtcbiAgICAgICAgICByZXR1cm4gYWNjdW07XG4gICAgICAgIH0sIFByb21pc2UucmVzb2x2ZShbXSkpO1xuICAgICAgICBjb25zdCBjb3BpZWRGaWxlcyA9IFtdO1xuICAgICAgICBmb3IgKGxldCBmaWxlIG9mIG1vZEZpbGVzKSB7XG4gICAgICAgICAgY29uc3QgcmVsUGF0aCA9IHBhdGgucmVsYXRpdmUoc3RhZ2luZ0ZvbGRlciwgZmlsZSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5zcGxpdChwYXRoLnNlcClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5zbGljZSgxKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmpvaW4ocGF0aC5zZXApO1xuICAgICAgICAgIGNvbnN0IGRlc3QgPSBwYXRoLmpvaW4oc3RhZ2luZ0ZvbGRlciwgcGFja2VyTW9kLmluc3RhbGxhdGlvblBhdGgsIHJlbFBhdGgpO1xuICAgICAgICAgIGF3YWl0IGZzLmVuc3VyZURpcldyaXRhYmxlQXN5bmMocGF0aC5kaXJuYW1lKGRlc3QpKTtcbiAgICAgICAgICBhd2FpdCBmcy5saW5rQXN5bmMoZmlsZSwgZGVzdCkuY2F0Y2goZXJyID0+IG51bGwpO1xuICAgICAgICAgIGNvcGllZEZpbGVzLnB1c2goZGVzdCk7XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IHBha0ZpbGUgPSBhd2FpdCBwYWNrZXIucnVuUGFja2VyKCk7XG4gICAgICAgICAgY29waWVkRmlsZXMucHVzaChwYWtGaWxlKTtcbiAgICAgICAgICBjb25zdCBtZXJnZWRNb2ROYW1lID0gJ21lcmdlZFBhayc7XG4gICAgICAgICAgY29uc3QgZGVzdCA9IHBhdGguam9pbihzdGFnaW5nRm9sZGVyLCBtZXJnZWRNb2ROYW1lLCBwYXRoLmJhc2VuYW1lKHBha0ZpbGUpKTtcbiAgICAgICAgICBhd2FpdCBmcy5yZW1vdmVBc3luYyhkZXN0KS5jYXRjaChlcnIgPT4gbnVsbCk7XG4gICAgICAgICAgYXdhaXQgcGFja2VyLmNyZWF0ZU1lcmdlZE1vZChtZXJnZWRNb2ROYW1lKTtcbiAgICAgICAgICBhd2FpdCBmcy5saW5rQXN5bmMocGFrRmlsZSwgZGVzdCkuY2F0Y2goZXJyID0+IG51bGwpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBjb250ZXh0LmFwaS5zaG93RXJyb3JOb3RpZmljYXRpb24oJ0ZhaWxlZCB0byBtZXJnZSBsb29zZSBmaWxlcycsIGVycik7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBDbGVhbnVwXG4gICAgICAgIGZvciAobGV0IGZpbGUgb2YgY29waWVkRmlsZXMpIHtcbiAgICAgICAgICBhd2FpdCBmcy5yZW1vdmVBc3luYyhmaWxlKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICB9KTtcbn1cbiJdfQ==